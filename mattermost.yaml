namespace: mattermost

database:
  defines: runnable
  containers:
    defines: containers
    postgres:
      image: postgres:12
      environment:
        - <- `POSTGRES_USER=${postgres-user}`
        - <- `POSTGRES_PASSWORD=${postgres-password}`
        - <- `POSTGRES_DB=${postgres-db}`
      paths:
        - <- `${db-path}:/var/lib/postgresql/data`
      ports:
        - 5432
  variables:
    defines: variables
    db-path:
      type: string
      value: <- `${monk-volume-path}/mattermost-database`
    postgres-user:
      type: string
      value: "mmuser"
    postgres-password:
      type: string
      value: "mmuser_password"
    postgres-db:
      type: string
      value: "mattermost"      
  checks:
    defines: checks
    readyness:
      code: true
      period: 15
      initialDelay: 10

mattermost:
  defines: runnable
  containers:
    defines: containers
    mattermost:
      image:  <- `mattermost/${MATTERMOST_IMAGE}`
      image-tag: <- `${MATTERMOST_IMAGE_TAG}`
      environment:
        - <- `MYSQL_ROOT_PASSWORD=${mysql-root-password}`
        - <- `MYSQL_USER=${wordpress-db-user}`
        - <- `MYSQL_PASSWORD=${wordpress-db-password}`
        - <- `MYSQL_DATABASE=${wordpress-db-name}`      
      paths:
        - <- `${MATTERMOST_CONFIG_PATH}:/mattermost/config`
        - <- `${MATTERMOST_DATA_PATH}:/mattermost/data`
        - <- `${MATTERMOST_LOGS_PATH}:/mattermost/logs`
        - <- `${MATTERMOST_PLUGINS_PATH}:/mattermost/plugins`
        - <- `${MATTERMOST_CLIENT_PLUGINS_PATH}:/mattermost/client/plugins`
        - <- `${MATTERMOST_BLEVE_INDEXES_PATH}:/mattermost/bleve-indexes`                                        
      ports:
        - 8065:8065
  depends:
    wait-for:
      runnables:
        - mattermost/database
      timeout: 30
  variables:
    defines: variables
    postgres-user:
      type: string
      value: "mmuser"
    postgres-password:
      type: string
      value: "mmuser_password"
    postgres-db:
      type: string
      value: "mattermost"       
    MATTERMOST_CONFIG_PATH:
      type: string
      value: "./volumes/app/mattermost/config"
    MATTERMOST_DATA_PATH:
      type: string
      value: "./volumes/app/mattermost/data"
    MATTERMOST_LOGS_PATH:
      type: string
      value: "./volumes/app/mattermost/logs"
    MATTERMOST_PLUGINS_PATH:
      type: string
      value: "./volumes/app/mattermost/plugins"
    MATTERMOST_CLIENT_PLUGINS_PATH:
      type: string
      value: "./volumes/app/mattermost/client/plugins"
    MATTERMOST_BLEVE_INDEXES_PATH:
      type: string
      value: "./volumes/app/mattermost/bleve-indexes"
    TZ:
      type: string
      value: "UTC"
    MM_SQLSETTINGS_DRIVERNAME:
      type: string
      value: "postgres"         
    MM_BLEVESETTINGS_INDEXDIR:
      type: string
      value: "/mattermost/bleve-indexes"
    MM_SERVICESETTINGS_SITEURL:
      type: string
      value: "https://mm.example.com"
    MATTERMOST_IMAGE:
      type: string
      value: "mattermost-enterprise-edition"
    MATTERMOST_IMAGE_TAG:
      type: string
      value: "6.3"   
    db-host:
      type: string
      value: <- get-hostname("mattermost/database", "postgres")
    MM_SQLSETTINGS_DATASOURCE:
      type: string
      value: <- `postgres://${postgres-user}:${postgres-password}@${db-host}:5432/${postgres-db}?sslmode=disable&connect_timeout=10`

